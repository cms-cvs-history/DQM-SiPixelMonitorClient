process SIPIXELDQM = {
  
  #=========================================================================================
  # Source - SLink dump

# source = PoolSource
#  {
#     untracked vstring fileNames = {
#       'file:/afs/cern.ch/user/f/fblekman/public/pixels/for_petra/pixelgain_dqm_example.root'
#}
#     
#   }

include "IORawData/SiPixelInputSources/data/PixelSLinkDataInputSource.cfi"
replace PixelSLinkDataInputSource.fileNames = 
#{"file:/FPixData/FPIX/HC-Z1/Runs_cold_338_340/SCurve_35_340.dmp"}
{"rfio:/castor/cern.ch/cms/store/TAC/PIXEL/FPIX/HC-Z1/HD1/Blades01_02_03/GainCalibration.23Aug07_1851.dmp"}
#{"rfio:/castor/cern.ch/cms/store/TAC/PIXEL/FPIX/HC-Z1/HD1/Blades01_02_03/PixelAlive.23Aug07_1857.dmp"}
#{"rfio:/castor/cern.ch/cms/store/TAC/PIXEL/FPIX/HC-Z1/HD1/Blades01_02_03/SCurve.23Aug07_1851.dmp"}

untracked PSet maxEvents = {untracked int32 input = 100}


  # End Sources
  #=========================================================================================
 
  # MessageLogger service
#   service = Timing{}
   service = MessageLogger{
	untracked vstring destinations = {"cout"}
	untracked PSet cout = {untracked string threshold = "INFO"}
   }

  #=========================================================================================
    service = AdaptorConfig {}
  #=========================================================================================
  # Geometry
	# Tracker SimGeometryXML
  	include "Geometry/TrackerSimData/data/trackerSimGeometryXML.cfi"
  	# Tracker Geometry Builder
  	include "Geometry/TrackerGeometryBuilder/data/trackerGeometry.cfi"
  	# Tracker Numbering Builder
  	include "Geometry/TrackerNumberingBuilder/data/trackerNumberingGeometry.cfi"
   	# magn. field
   	include "MagneticField/Engine/data/volumeBasedMagneticField.cfi"

  # End Geometry

include "CalibFormats/SiPixelObjects/data/SiPixelCalibConfiguration.cfi"

replace sipixelcalib_essource.toGet = {
	{
		string record = "SiPixelCalibConfigurationRcd"
		string tag = "SCurve_340"
	},
	{
		string record = "SiPixelFedCablingMapRcd"
		string tag = "SiPixelFedCablingMap_v9"
	}
}

include "CondTools/SiPixel/data/SiPixelGainCalibrationService.cfi"

#service = PoolDBOutputService{
#	string timetype = "runnumber"
#	string connect = "sqlite_file:prova_rawdata.db"
#	VPSet toPut = {{string record = "SiPixelGainCalibrationRcd" string tag = "GainCalib_v2_test"}}
#	PSet DBParameters = {
#		untracked string authenticationPath = "./"
#		untracked int32 messageLevel = 1
#		}
#}




# Raw to Digi conversion

include "EventFilter/SiPixelRawToDigi/data/SiPixelRawToDigi.cfi"
replace siPixelDigis.InputLabel = "source"
replace siPixelDigis.IncludeErrors = true

# Calibration module

include "CalibTracker/SiPixelGainCalibration/data/SiPixelCalibDigiProducer.cfi"

include "CalibTracker/SiPixelSCurveCalibration/data/SiPixelSCurveCalibrationAnalysis.cfi"
include "CalibTracker/SiPixelIsAliveCalibration/data/SiPixelIsAliveCalibration.cfi"
include "CalibTracker/SiPixelGainCalibration/data/SiPixelGainCalibrationAnalysis.cfi"

# replace siPixelIsAliveCalibration.src = "siPixelDigis"

# replace siPixelIsAliveCalibration.outputFileName = "test_ffgain.root"
 replace siPixelIsAliveCalibration.DetSetVectorSiPixelCalibDigiTag = siPixelCalibDigis
 replace siPixelGainCalibrationAnalysis.DetSetVectorSiPixelCalibDigiTag = siPixelCalibDigis



# Reconstruction modules

include "RecoLocalTracker/SiPixelRecHits/data/SiPixelRecHits.cfi"

  #=========================================================================================
  # SiPixel DQM Modules:
    # SiPixelMonitorRawData
    	include "DQM/SiPixelMonitorRawData/data/SiPixelMonitorRawData.cfi"

    # SiPixelMonitorDigi
    	include "DQM/SiPixelMonitorDigi/data/SiPixelMonitorDigi.cfi"

  ################ The Client (SiPixelEDAClient) ################
   module sipixelEDAClient = SiPixelEDAClient {
     untracked int32  CollationtionFlag = 0
     untracked int32  FileSaveFrequency = 50
     untracked int32  StaticUpdateFrequency = 10
     untracked string OutputFilePath = "."     
   }
  # End Modules Configuration
  #=========================================================================================
  
  # DQM services
#  	service = DaqMonitorROOTBackEnd{}
	service = DQMShipMonitoring{ untracked uint32 period = 1000 }

    module preScaler  = Prescaler{ int32 prescaleFactor = 1 }

    # DQM Online Environment
    module dqmEnv = DQMEventInfo {
	untracked string eventInfoFolder = "EventInfo"
	untracked string subSystemFolder = "Pixel"
    }
    
    # DQM Online File saver module
    module dqmSaver = DQMFileSaver {
        untracked string dirName = "."
	untracked string fileName = "Pixel"
	untracked int32 prescaleLS = 1
	untracked string environment = "Online"
	untracked int32 prescaleEvt = -1
	untracked int32 prescaleTime = -1
	untracked bool saveAtRunEnd = true
	untracked bool saveAtJobEnd = false
    }

  #=========================================================================================

   service = ModuleWebRegistry { }
   service = LockService { untracked vstring labels = { "source" } }

######################## Scheduling
    sequence DigiReco = {
        siPixelDigis
    }
    
    sequence CalibAnalysis = {
        siPixelCalibDigis,
	siPixelSCurveAnalysis,
	siPixelGainCalibrationAnalysis,
	siPixelIsAliveCalibration
    }

    sequence RAWmonitor = {
      SiPixelRawDataErrorSource
    }
    sequence DIGImonitor = {
      SiPixelDigiSource
    }
    sequence DQMmodules = {
      dqmEnv,
      dqmSaver
    }
    
  # End Schedule
  #=========================================================================================
  #path p = {RAWmonitor,DIGImonitor,sipixelEDAClient,DQMmodules}
  path p = {	
		DigiReco,
		CalibAnalysis,
		RAWmonitor,
		DIGImonitor,
		sipixelEDAClient,
		DQMmodules
	   }

}

